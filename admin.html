<!DOCTYPE html>
<html lang="en">
<head>
  <title>Admin</title>

  <!-- Libraries -->
  <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/css/bootstrap-combined.min.css" rel="stylesheet">
  <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/js/bootstrap.min.js"></script>

  <!-- StackMob Dependencies -->
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.8.0-bundled-min.js"></script>

  <!-- Site Dependencies -->
  <script type="text/javascript" src="site.js"></script>
  <link rel="stylesheet" href="site.css">

  <!-- Page Code -->
  <script type="text/javascript">
  /* <![CDATA[ */
  $(document).ready(function(){

    /* On Page Load */
    if (getParameterByName('message')!=""){
      $("#status").addClass("alert").html(getParameterByName('message'));
    }

    locations.query(qAll, {
      success: function(col){

        col.comparator = function(model) {
            return model.get('name');
        }
       col.sort().each(function(model){
          /* Add location for new user */
          $("#locationsListForAddUser").append(
            $('<option></option>').val(model.get('location_id')).html(model.get('name'))
          );
          /* Add locations list for new coffee */
          $("#locationsListForAddCoffee").append(
            $('<option></option>').val(model.get('location_id')).html(model.get('name'))
          );

          /* Add locations list for remove location */
          $("#locationsListForRemoveLocation").append(
            $('<option></option>').val(model.get('location_id')).html(model.get('name'))
          );

          $('#locationsListForAddSingleCoffee').append(
            $('<option></option>').val(model.get('location_id')).html(model.get('name'))
          );

          $('#locationsListForRemovingSingleCoffee').append(
            $('<option></option>').val(model.get('location_id')).html(model.get('name'))
          );
       });
     },
     error: function(){ console.log("bad locations query"); }
   });

    coffees.query(qAll, {
      success: function(col){
        col.comparator = function(model) {
            return model.get('name');
        }
       col.sort().each(function(model){
        /* Add coffees list for new location */
        $("#coffeesListForAddLocation").append(
          $('<option></option>').val(model.get('coffee_id')).html(model.get('name'))
        );

        /* Add coffees list for remove coffee */
        $('#coffeesListForRemoveCoffee').append(
          $('<option></option>').val(model.get('coffee_id')).html(model.get('name'))
        );

        $('#coffeesListForAddSingleCoffee').append(
          $('<option></option>').val(model.get('coffee_id')).html(model.get('name'))
        );

        $('#coffeesListForRemovingSingleCoffee').append(
          $('<option></option>').val(model.get('coffee_id')).html(model.get('name'))
        );
      })
     },
     error: function(){ console.log("bad coffee query"); }
   });

    users.query(qAll, {
      success: function(col){

        col.comparator = function(model) {
            return model.get('username');
        }
       col.sort().each(function(model){
        /* Add coffees list for new location */
        $("#usersListForRemoveUser").append(
          $('<option></option>').val(model.get('username')).html(model.get('username'))
          );
      })
     },
     error: function(){ console.log("bad users query"); }
   });

    $('#newUser').click(function(){
    	var newUser = new StackMob.User({
        username : $('#username').val(),
        password : $('#password').val(),
        location : $('#locationsListForAddUser').val() || undefined
      });
    	console.log(newUser);
    	newUser.create({

    		success: function(model){
          window.location = '?message=Successfully created user ' + model.get('username') + ' who works at ' + $('#locationsList option:selected').text() + '.';
        },
        error: function(){ console.log("bad"); }
      });
    });

    $('#removeUser').click(function(){
      var newUser = new StackMob.User({
        username : $('#usersListForRemoveUser').val(),
      });
      console.log(newUser);
      newUser.destroy({

        success: function(model){
          redirectWithMessage("", "Successfully removed user.");
        },
        error: function(){ console.log("bad"); }
      });
    });

    $('#newLocation').click(function(){
      $.when(createNewLocation($('#locationName').val(), $('#coffeesListForAddLocation').val()))
      .then(
        function(status){
          // Done
          var locationId = status.id;
          if ( $('#coffeesListForAddLocation').val() != null ){
            var deferreds = $('#coffeesListForAddLocation').val().map(function(coffeeId) {
              return assignLocationToCoffee(coffeeId, locationId);
            });

            $.when.apply(null, deferreds)
            .then(
              function(status) {
                // Done
                redirectWithMessage("", "Successfully created location " + status.get('name') + " at " + status.get('address') + ".");
              },
              function(status) {
                // Fail
                console.log("Error");
              }
            );
          }
        },
        function(status){
          // Fail
          console.log("Error");
        }
      );
      // .pipe (function() {
      //     return $.get('pages/test.html'); // the return value creates a new Deferred object
      // })
      // .done (function(args)
      // {
      //     alert (args);
      // });

      // newLocation.create({

      //   success: function(model){
      //     var location_id = model.location_id;
      //     $('#coffeesListForAddLocation').val().each(function(coffee_id){

      //        Send request for each coffee to append location
      //     });

      //     window.location = '?message=Successfully created location ' + model.get('name') + ' at ' + model.get('address') + '.';
      //   },
      //   error: function(){ console.log("bad"); }
      // });

    });

    $('#removeLocation').click(function(){
      var newLocation = new Loc({
        location_id : $('#locationsListForRemoveLocation').val(),
      });
      newLocation.destroy({

        success: function(model){
          redirectWithMessage("", "Successfully removed location.";
        },
        error: function(){ console.log("bad"); }
      });
    });

    $('#newCoffee').click(function(){
      var newCoffee = new Coffee({
        name : $('#coffeeName').val(),
        locations : $('#locationsListForAddCoffee').val() || undefined
      });
      console.log(newCoffee);
      newCoffee.create({

        success: function(model){
          redirectWithMessage("","?message=Successfully created coffee " + model.get('name') + " from " + model.get('origin') + ".");
        },
        error: function(){ console.log("bad"); }
      });
    });

    $('#addCoffeeToLocation').click(function(){
      var newLocation = new Loc({
        location_id : $('#locationsListForAddSingleCoffee').val()
      });
      newLocation.appendAndSave('coffees', [$('#coffeesListForAddSingleCoffee').val()], {

        success: function(model){

          var newCoffee = new Coffee({
            coffee_id : $('#coffeesListForAddSingleCoffee').val()
          });
          newCoffee.appendAndSave('locations', [$('#locationsListForAddSingleCoffee').val()], {

            success: function(model2){
              redirectWithMessage("","?message=Added " + model2.name + " to " + model.name + ".");
            },
            error: function(){
              console.log("bad");
            }
          });

        },
        error: function(){
          console.log("bad");
        }
      });

    });

    $('#removeCoffeeFromLocation').click(function(){
      var newLocation = new Loc({
        location_id : $('#locationsListForRemovingSingleCoffee').val()
      });
      newLocation.deleteAndSave('coffees', [$('#coffeesListForRemovingSingleCoffee').val()], StackMob.SOFT_DELETE, {

        success: function(model){
          var newCoffee = new Coffee({
            coffee_id : $('#coffeesListForRemovingSingleCoffee').val()
          });
          newCoffee.deleteAndSave('locations', [$('#locationsListForRemovingSingleCoffee').val()], StackMob.SOFT_DELETE, {

            success: function(model2){
              window.location = '?message=Removed ' + model2.name + ' from ' + model.name + '.';
            },
            error: function(){ 
              console.log("bad"); 
            }
          });
        },
        error: function(){ 
          console.log("bad"); 
        } 
      });

    });


    $('#removeCoffee').click(function(){
      var newCoffee = new Coffee({
        coffee_id : $('#coffeesListForRemoveCoffee').val(),
      });
      newCoffee.destroy({

        success: function(model){

          window.location = '?message=Successfully removed coffee.';

        },
        error: function(){ console.log("bad"); }
      });
    });
});

/* ]]> */
</script>

</head>
<body>

  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
        <a class="brand" href="#">Coffee Log</a>
        <div class="nav-collapse">
          <ul class="nav">
            <li><a href="/">Home</a></li>
            <li class="active"><a href="/admin.html">Admin</a></li>
            <li><a href="/login.html">Login</a></li>
            <li><a href="/login.html?logout=true">Logout</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row-fluid">

      <div class="span12">
        <div id="status"></div>
      </div>

    </div>
    <div class="row-fluid">

      <div class="span4">
        <div class="well">
          <h2>Create New Coffee:</h2>
          <label>Name:</label> <input id="coffeeName" type="text"></input>
          <label>Add To Locations:</label>
          <select size='10' id="locationsListForAddCoffee" multiple></select><br />
          <input id="newCoffee" class="btn btn-primary" type="button" value="Submit"></input>
        </div>
      </div>

      <div class="span4">
        <div class="well">
          <h2>Create New Location:</h2>
          <label>Name:</label> <input id="locationName" type="text"></input>
          <label>Add Coffees for this Location:</label>
          <select size='10' id="coffeesListForAddLocation" multiple></select><br />
          <input id="newLocation" class="btn btn-primary" type="button" value="Submit"></input>
        </div>
      </div>

      <div class="span4">
        <div class="well">
          <h2>Create New User:</h2>
          <label>Username:</label> <input id="username" type="text"></input>
          <label>Password:</label> <input id="password" type="password"></input>
          <label>Works At:</label>
          <select id="locationsListForAddUser"></select><br />
          <input id="newUser" class="btn btn-primary" type="button" value="Submit"></input>
        </div>
      </div>

    </div>
    <div class="row-fluid">

      <div class="span4">
        <div class="well">
          <h2>Add Coffee:</h2>
          <select id="coffeesListForAddSingleCoffee"></select><br />
          <h2>To Location:</h2>
          <select id="locationsListForAddSingleCoffee"></select><br />
          <input id="addCoffeeToLocation" class="btn btn-primary" type="button" value="Submit"></input>
        </div>
      </div>

      <div class="span4">
        <div class="well">
          <h2>Remove Coffee:</h2>
          <select id="coffeesListForRemovingSingleCoffee"></select><br />
          <h2>From Location:</h2>
          <select id="locationsListForRemovingSingleCoffee"></select><br />
          <input id="removeCoffeeFromLocation" class="btn btn-primary" type="button" value="Submit"></input>
        </div>
      </div>

      <div class="span4">
        <div class="well">
          <h2>Remove Location:</h2>
          <select id="locationsListForRemoveLocation"></select><br />
          <input id="removeLocation" class="btn btn-primary" type="button" value="Submit"></input>
        </div>
      </div>

      <div class="span4">
        <div class="well">
          <h2>Remove User:</h2>
          <select id="usersListForRemoveUser"></select><br />
          <input id="removeUser" class="btn btn-primary" type="button" value="Submit"></input>
        </div>
      </div>

    </div>
    <div class="row-fluid">

      <div class="span4">
        <div class="well">
          <h2>Remove Coffee:</h2>
          <select id="coffeesListForRemoveCoffee"></select><br />
          <input id="removeCoffee" class="btn btn-primary" type="button" value="Submit"></input>
        </div>
      </div>

    </div>
  </div>

</body>
</html>
