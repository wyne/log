<!DOCTYPE html>
<html lang="en">
<head>
  <title>Coffee Log</title>

  <!-- StackMob Dependencies -->
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.9.1-bundled-min.js"></script>

  <!-- Libraries -->
  <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/css/bootstrap-combined.min.css" rel="stylesheet">
  <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/js/bootstrap.min.js"></script>
  <link href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" rel="stylesheet">
  <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>

  <!-- Site Dependencies -->
  <script type="text/javascript" src="site.js"></script>
  <link rel="stylesheet" href="site.css">

  <!-- Page Code -->
  <script type="text/javascript">
  /* <![CDATA[ */
    $(document).ready(function(){
      var qLocations = new StackMob.Collection.Query();
      qLocations.orderAsc('name');
      locations.query(qLocations, {
      success: function(results){
       $("#locationsList").append(
            $('<option></option>').val('ALL').html('All Locations')
        );
       results.each(function(model){
          $("#locationsList").append(
            $('<option></option>').val(model.get('location_id')).html(model.get('name'))
          );

       });
     },
     error: function(){ console.log("bad locations query"); }
   });

    var qCoffees = new StackMob.Collection.Query();
    qCoffees.orderAsc('name');
    coffees.query(qCoffees, {
      success: function(results){
        $("#coffeesList").append(
            $('<option></option>').val('ALL').html('All Coffees')
        );
       results.each(function(model){
        $("#coffeesList").append(
          $('<option></option>').val(model.get('coffee_id')).html(model.get('name'))
        );
       });
       populateRoasts();
     },
     error: function(){ console.log("bad coffee query"); }
   });

    function populateRoasts(){
      $('#roastsList').html("");
      var selectedCoffee = $('#coffeesList').val();

      var qRoasts = new StackMob.Collection.Query();
      if (selectedCoffee != 'ALL') {
        qRoasts.equals('coffee', selectedCoffee);
      }
      qRoasts.orderAsc('date');
       roasts.query(qRoasts, {
        success : function(results) {
          if (results.size() != 0) {
            results.each(function(model){
              var newDate = new Date(model.get('date'));
              $("#roastsList").append(
                $('<option></option>').val(model.get('roast_id')).html((newDate.getMonth() + 1) + "/" + newDate.getDate() + "/" + newDate.getFullYear())
              );
            })
          } else {
            $("#roastsList").append( $('<option></option>').html("No Roasts") );
          }
          
        },
        error : function(model, response) {
          console.log(response);
        }
      });

    };

    function populateCoffees(){
      $('#coffeesList').html("");
      var selectedLocation = $('#locationsList').val();

      var qCoffees = new StackMob.Collection.Query();
      if (selectedLocation != 'ALL') {
        qCoffees.mustBeOneOf('locations', selectedLocation);
      }

      qCoffees.orderAsc('name');
      coffees.query(qCoffees, {
      success: function(results){
        if (results.size() != 0) {
          $("#coffeesList").append(
            $('<option></option>').val('ALL').html('All Coffees')
            );
          results.each(function(model){
            $("#coffeesList").append(
              $('<option></option>').val(model.get('coffee_id')).html(model.get('name'))
              );
          });
          populateRoasts();
        } else {
          $("#coffeesList").append(
            $('<option></option>').val('NONE').html('No Coffees')
          );
          $('#roastsList').html("");
        }
        
     },
     error: function(){ console.log("bad coffee query"); }
     });

    }

    var arrayOfEspressoFields = _.union(['sm_owner', 'preparation_date'], _.sortBy(['weight_of_dose', 'flavor', 'fragrance_aroma', 'mouthfeel', 'negative_notes', 'positive_notes', 'pre_infuse_pressure', 'espresso_prep_type', 'preinfuse_time', 'total_extraction_time', 'shift', 'acidity', 'weight_of_yield', 'aftertaste'], function(a){ return a }));

    var arrayOfDripFields = _.union(['sm_owner', 'preparation_date'], _.sortBy(['flavor', 'fragrance_aroma', 'mouthfeel', 'negative_notes', 'positive_notes','total_extraction_time', 'milk', 'aftertaste', 'dose_of_coffee', 'acidity', 'dose_of_water', 'shift', 'grind', 'bloom_time'], function(a){ return a }));

    var arrayOfSiphonFields = _.union(['sm_owner', 'preparation_date'], _.sortBy(['shift', 'brewing_time', 'steep_time', 'grind', 'dose_of_coffee', 'weight_of_water', 'drawdown_time', 'total_extraction_time', 'aftertaste', 'acidity', 'flavor', 'fragrance_aroma', 'mouthfeel', 'negative_notes', 'positive_notes'], function(a){ return a }));

    var timeFields = ['preinfuse_time', 'total_extraction_time', 'bloom_time', 'brewing_time', 'steep_time', 'drawdown_time'];

    function queryEspressoNotesBasedOnRoast(){
      if ($('#espresso_checkbox').is(':checked')) {
        console.log("Querying all espresso notes for roast date");
        var qEspressoNotes = new StackMob.Collection.Query();
        // Add OR support for multiple roasts selected
        qEspressoNotes.equals('roast', $('#roastsList').val());
        $('input:checkbox:checked.sort_checkbox').each(function(idx,obj){ 
          qEspressoNotes.orderAsc($(obj).val()); 
        });
        espressoNotes.query(qEspressoNotes, {
          success : function(results){
            console.log('Successfully got all espresso notes');
            populateEspressoTable();
            results.each(function(model){
              var columnData = [];
              _.each(arrayOfEspressoFields, function(idx, item){
                var field = arrayOfEspressoFields[item];
                var entry;
                if (field == "preparation_date") {
                  var newDate = new Date(model.get(field));
                  entry = (newDate.getMonth() + 1) + "/" + newDate.getDate() + "/" + newDate.getFullYear();
                } else if (field == "sm_owner") {
                  entry = model.get(field).split("/")[1];
                } else if (timeFields.indexOf(field) != -1){
                  entry = millisecondsToDurationString(model.get(field));
                } else {
                  entry = model.get(field);
                }

                columnData.push($('<td></td>').html(entry));
              });
              $('#espressoTableData').append(
                $('<tr></tr>').append(
                  columnData
                )
              )
            });
            queryDripNotesBasedOnRoast();
          },
          error : function(model, response){
            console.log(response);
          }
        });
      } else {
        queryDripNotesBasedOnRoast();
      }
    };

    function queryDripNotesBasedOnRoast(){
      if ($('#drip_checkbox').is(':checked')) {
        console.log("Querying all drip notes for roast date");
        var qDripNotes = new StackMob.Collection.Query();
        qDripNotes.equals('roast', $('#roastsList').val());
        $('input:checkbox:checked.sort_checkbox').each(function(idx,obj){ 
          qDripNotes.orderAsc($(obj).val()); 
        });
        dripNotes.query(qDripNotes, {
          success : function(results){
            console.log('Successfully got all drip notes');
            populateDripTable();
            results.each(function(model){
              var columnData = [];
              _.each(arrayOfDripFields, function(idx, item){
                var field = arrayOfDripFields[item];
                var entry;
                if (field == "preparation_date") {
                  var newDate = new Date(model.get(field));
                  entry = (newDate.getMonth() + 1) + "/" + newDate.getDate() + "/" + newDate.getFullYear();
                } else if (timeFields.indexOf(field) != -1){
                  entry = millisecondsToDurationString(model.get(field));
                } else if (field == "sm_owner") {
                  entry = model.get(field).split("/")[1];
                } else if (field == "milk") {
                  entry = model.get(field) ? "YES" : "NO";
                } else {
                  entry = model.get(field);
                }

                columnData.push($('<td></td>').html(entry));
              });
              $('#dripTableData').append(
                $('<tr></tr>').append(
                  columnData
                )
              )
            });
            querySiphonNotesBasedOnRoast();
          },
          error : function(model, response){
            console.log(response);
          }
        });
      } else {
        querySiphonNotesBasedOnRoast();
      }
    };

    function querySiphonNotesBasedOnRoast(){
      if ($('#siphon_checkbox').is(':checked')) {
        console.log("Querying all siphon notes for roast date");
        var qSiphonNotes = new StackMob.Collection.Query();
        qSiphonNotes.equals('roast', $('#roastsList').val());
        qSiphonNotes.orderAsc('siphon_note_id');
        siphonNotes.query(qSiphonNotes, {
          success : function(results){
            console.log('Successfully got all siphon notes');
            populateSiphonTable();
            results.each(function(model){
              var columnData = [];
              _.each(arrayOfSiphonFields, function(idx, item){
                var field = arrayOfSiphonFields[item];
                var entry;
                if (field == "preparation_date") {
                  var newDate = new Date(model.get(field));
                  entry = (newDate.getMonth() + 1) + "/" + newDate.getDate() + "/" + newDate.getFullYear();
                } else if (field == "sm_owner") {
                  entry = model.get(field).split("/")[1];
                } else if (timeFields.indexOf(field) != -1){
                  entry = millisecondsToDurationString(model.get(field));
                } else {
                  entry = model.get(field);
                }

                columnData.push($('<td></td>').html(entry));
              });
              $('#siphonTableData').append(
                $('<tr></tr>').append(
                  columnData
                )
              )
            });
          },
          error : function(model, response){
            console.log(response);
          }
        });
      }
    }

    $('#locationsList').change(function(){
      populateCoffees();
    });
    $('#coffeesList').change(function(){
      populateRoasts();
    });

    function populateEspressoTable() {
      var columnHeaders = [];
      _.each(arrayOfEspressoFields, function(idx, item){
        var entry = arrayOfEspressoFields[item];
        if (entry == "sm_owner") {
          entry = "location";
        }
        columnHeaders.push($('<th></th>').html(entry));
      })
      $('#espressoTableData').append(
        $('<tr></tr>').append(
          columnHeaders
        )
      )
    };

    function populateDripTable() {
      var columnHeaders = [];
      _.each(arrayOfDripFields, function(idx, item){
        var entry = arrayOfDripFields[item];
        if (entry == "sm_owner") {
          entry = "location";
        }
        columnHeaders.push($('<th></th>').html(entry));
      })
      $('#dripTableData').append(
        $('<tr></tr>').append(
          columnHeaders
        )
      )
    };

    function populateSiphonTable() {
      var columnHeaders = [];
      _.each(arrayOfSiphonFields, function(idx, item){
        var entry = arrayOfSiphonFields[item];
        if (entry == "sm_owner") {
          entry = "location";
        }
        columnHeaders.push($('<th></th>').html(entry));
      })
      $('#siphonTableData').append(
        $('<tr></tr>').append(
          columnHeaders
        )
      )
    };

    $('#getNotesFromRoast').click(function(e){
      e.preventDefault();
      $('#espressoTableData').html("");
      $('#dripTableData').html("");
      $('#siphonTableData').html("");
      $('#showingNotesForRostDate').html("");
      $('#showingNotesForRostDate').append("Showing notes for " + $('#roastsList').find(":selected").text() + "  roast of " + $('#coffeesList').find(":selected").text() + ".");
      queryEspressoNotesBasedOnRoast();
    });

    $(".export-button").click(function(){
      saveTable( $(this).data("target") );
    })

  });
  /* ]]> */
  </script>

</head>
<body>

  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
        <a class="brand" href="#">Coffee Log</a>
        <div class="nav-collapse">
          <ul class="nav">
            <li><a href="/">Home</a></li>
            <li class="admin"><a href="/admin.html">Admin</a></li>
            <li class="active admin"><a href="/data.html">Data</a></li>
            <li><a href="/login.html">Login</a></li>
            <li><a href="/login.html?logout=true">Logout</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row-fluid">
      <div class="span4">
        <label>Choose Location:</label><select id="locationsList"></select>
      </div>
      <div class="span4">
        <label>Choose Coffee:</label><select id="coffeesList"></select>
      </div>
      <div class="span4">
        <label>Choose Roast:</label><select size="10" id="roastsList" multiple></select>
      </div>
    </div>
    <div class="row-fluid">
      <label>Type Of Note:</label>
      <label class="checkbox inline">
        <input id="espresso_checkbox" type="checkbox">Espresso</input>
      </label>
      <label class="checkbox inline">
        <input id="drip_checkbox" type="checkbox">Drip</input>
      </label>
      <label class="checkbox inline">
        <input id="siphon_checkbox" type="checkbox">Siphon</input>
      </label>
    </div>

    <div class="row-fluid">
    <p></p>
    <label>Sort By:</label>
    <label class="checkbox inline">
        <input id="acidity_checkbox" class="sort_checkbox" type="checkbox" value="acidity">Acidity</input>
    </label>
    <label class="checkbox inline">
        <input id="aftertaste_checkbox" class="sort_checkbox" type="checkbox" value="aftertaste">Aftertaste</input>
    </label>
    <label class="checkbox inline">
        <input id="dose_weight_checkbox" class="sort_checkbox" type="checkbox" value="dose_weight">Dose Weight</input>
    </label>
    <label class="checkbox inline">
        <input id="flavor_checkbox" class="sort_checkbox" type="checkbox" value="flavor">Flavor</input>
    </label>
    <label class="checkbox inline">
        <input id="fragrance_aroma_checkbox" class="sort_checkbox" type="checkbox" value="fragrance_aroma">Fragrance Aroma</input>
    </label>
    <label class="checkbox inline">
        <input id="mouthfeel_checkbox" class="sort_checkbox" type="checkbox" value="mouthfeel">Mouthfeel</input>
    </label>
    <label class="checkbox inline">
        <input id="positive_notes_checkbox" class="sort_checkbox" type="checkbox" value="positive_notes">Positive Notes</input>
    </label>
    <label class="checkbox inline">
        <input id="negative_notes_checkbox" class="sort_checkbox" type="checkbox" value="negative_notes">Negative Notes</input>
    </label>
    <label class="checkbox inline">
        <input id="prep_date_checkbox" class="sort_checkbox" type="checkbox" value="prep_date">Prep Date</input>
    </label>
    <label class="checkbox inline">
        <input id="total_extraction_time_checkbox" class="sort_checkbox" type="checkbox" value="total_extraction_time">Total Extraction Time</input>
    </label>
    <label class="checkbox inline">
        <input id="yield_date_checkbox" class="sort_checkbox" type="checkbox" value="yield_weight">Yield Weight</input>
    </label>
    </p></div>
    <input id="getNotesFromRoast" class="btn btn-primary" type="button" value="Get Data"></input>

    <p></p>

    <p id="showingNotesForRostDate"></p>

    <div class="divider"></div>

    <div class="table-wrapper">
      <table border="1" id="espressoTableData" class="table table-bordered table-hover"></table>
    </div>

    <input class="btn btn-info export-button" type="button" value="Export Espresso Data to CSV" data-target="espressoTableData" />

    <div class="divider"></div>

    <div class="table-wrapper">
      <table border="1" id="dripTableData" class="table table-bordered table-hover"></table>
    </div>

    <input class="btn btn-info export-button" type="button" value="Export Drip Data to CSV" data-target="dripTableData" />

    <div class="divider"></div>

    <div class="table-wrapper">
      <table border="1" id="siphonTableData" class="table table-bordered table-hover"></table>
    </div>

    <input class="btn btn-info export-button" type="button" value="Export Siphon Data to CSV" data-target="siphonTableData" />

  </div>

  <!--
    <label>Locations:</label><select size='10' id="locationsList" multiple><option value="None">N/A</option></select><br />
    <label>Type:</label><select size='10' id="typeList" multiple><option value="None">N/A</option><option value="Espresso">Espresso</option><option value="Drip">Drip</option><option value="Siphon">Siphon</option></select><br />
    <label>Data:</label><select size='10' id="dataList" multiple></select><br />
  -->
</body>
</html>
