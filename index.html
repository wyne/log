<!DOCTYPE html>
<html lang="en">
<head>
  <title>Coffee Log</title>

  <!-- StackMob Dependencies -->
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.8.0-bundled-min.js"></script>

  <!-- Libraries -->
  <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/css/bootstrap-combined.min.css" rel="stylesheet">
  <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/js/bootstrap.min.js"></script>
  <link href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" rel="stylesheet">
  <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>

  <!-- Site Dependencies -->
  <script type="text/javascript" src="site.js"></script>
  <link rel="stylesheet" href="site.css">

  <!-- Page Code -->
  <script type="text/javascript">
  /* <![CDATA[ */
    $(document).ready(function(){

      var locationCoffees;

      StackMob.getLoggedInUser( {
        success: function(name){
          var user = new StackMob.User({
            username : name
          });
          user.fetchExpanded(2, {

            success : function(model){
              var locationObject = new Loc(model.get('location'));
              if (typeof locationObject !== 'undefined') {
                // Display Location of user
                $('#usersLocation').append(
                  "Logged in at " + locationObject.get("name")
                );
                // Get all coffees for that location and display
                locationCoffees = locationObject.get("coffees");
                if (typeof locationCoffees !== 'undefined') {
                  _.sortBy(locationCoffees, function(model) {
                    return model.name;
                  });

                  _.each(locationCoffees, function(model) {
                    $("#coffeesListForLocation").append(
                      $('<option></option>').val(model.coffee_id).html(model.name)
                    );
                  })
                }
              } else {
                console.log('No Location object found');
              }

            },
            error : function(model, response){
              console.log("Error: " + response);
            }

          });
        },
        error : function(model, response) {
          console.log("Error: " + response);
        }
      });

      function submitEspressoNote(json){
        console.log('submitting espresso note');
        json.roast_date = undefined;
        var newNote = new EspressoNote(json);
        newNote.create({
          success : function (model) {
            console.log("Success, new roast");
          },
          error : function(model, response) {
            console.log("Error saving note.");
          }
        })
      };

      $("#espresso_note_form").submit(function(e){
        e.preventDefault();
        var jsonForm = {};//$(this).serializeArray();
        $(this).find('input').each(function(){
          if ($(this).val() != "" && $(this).attr("type") != "submit") {
            if ($(this).attr('type') == "number") {
              jsonForm[$(this).attr("name")] = parseInt($(this).val());
            } else if ($(this).hasClass("date-input") ) {
              jsonForm[$(this).attr("name")] = new Date($(this).val()).getTime();
            } else if ($(this).attr("type") == "radio") {
              if ($(this).is(":checked")) {
                jsonForm[$(this).attr("name")] = $(this).val();
              }
            } else {
              jsonForm[$(this).attr("name")] = $(this).val();
            }
          }
        });
        var roastQuery = new StackMob.Collection.Query();

        if (!jsonForm.roast_date) {
          // Handle error
        }

        roastQuery.equals('date', jsonForm.roast_date).equals('coffee', $("#coffeesListForLocation").val());


        roasts.query(roastQuery, {
          success: function(col){
            if (col.length == 0) {
              // Create new roast
              console.log("Creating new roast");
              var newRoast = new Roast({
                date : jsonForm.roast_date,
                coffee : $("#coffeesListForLocation").val()
              });
              newRoast.create({
                success : function(model){
                  jsonForm["roast"] = model.get('roast_id');
                  submitEspressoNote(jsonForm);
                },
                error : function(model, response){}
              });
            } else {
              // make check for 1 item only
              jsonForm["roast"] = col.at(0).get('roast_id');
              submitEspressoNote(jsonForm);
            }
          },
          error : function(model, response){}
        });

      });
    });
  /* ]]> */
  </script>

</head>
<body>

  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
        <a class="brand" href="#">Coffee Log</a>
        <div class="nav-collapse">
          <ul class="nav">
            <li class="active"><a href="/">Home</a></li>
            <li class="admin"><a href="/admin.html">Admin</a></li>
            <li class="admin"><a href="/data.html">Data</a></li>
            <li><a href="/login.html">Login</a></li>
            <li><a href="/login.html?logout=true">Logout</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row-fluid">
      <div class="span8 offset2">
        <h2 class="current-location"></h2>
        <h2 id="usersLocation"></h2>
        <h2>Pick your coffee:</h2>
        <select id="coffeesListForLocation"></select><br />

        <ul class="nav nav-tabs" id="myTab" data-tabs="tabs">
          <li class="active"><a href="#espresso" data-toggle="tab">Espresso</a></li>
          <li><a href="#drip" data-toggle="tab">Drip</a></li>
          <li><a href="#siphon" data-toggle="tab">Siphon</a></li>
        </ul>

        <div class="tab-content">
          <div class="tab-pane active" id="espresso">

            <div id="espresso_note">
              <form id="espresso_note_form">
                <div class="row-fluid">
                  <div class="span6">
                    <label>Roast Date:</label> <input type="text" name="roast_date" class="date-input">
                    <label>Preparation Date:</label> <input type="text" name="prep_date" class="date-input">

                    <div class="clear"></div>
                    <span style="float:left;">Shift:<span>

                    <label class="radio inline">
                      <input type="radio" name="shift" value="AM" class="shift" checked="true"> AM
                    </label>
                    <label class="radio inline">
                      <input type="radio" name="shift" value="PM" class="shift"> PM
                    </label>

                    <label>Weight Of Dose:</label> <input type="number" name="dose_weight">
                    <label>Weight Of Yield:</label> <input type="number" name="yield_weight">
                    <label>Preinfuse Time:</label> <input type="number" name="preinfuse_time">
                    <label>Preinfuse Pressure:</label> <input type="number" name="preinfuse_pressure">
                    <label>Total Extraction Time:</label> <input type="number" name="total_extraction_time">
                  </div>
                  <div class="span6">
                    <label>Fragrance Aroma:</label> <input type="text" name="fragrance_aroma">
                    <label>Acidity:</label> <input type="text" name="acitdity">
                    <label>Mouthfeel:</label> <input type="text" name="mouthfeel">
                    <label>Flavor:</label> <input type="text" name="flavor">
                    <label>Aftertaste:</label> <input type="text" name="aftertaste">
                    <label>Positive Notes:</label> <input type="text" name="postitive_notes">
                    <label>Negative Notes:</label> <input type="text" name="negative_notes">
                  </div>
                </div>
                <div class="row">
                  <div class="span6 offset6">
                    <input class="login btn btn-primary" type="submit" value="Submit Espresso Note"></input>
                  </div>
                </div>

              </form>
            </div>

          </div>
          <div class="tab-pane" id="drip">

            <div id="drip_note">
              <form id="drip_note_form">
                <label>Roast Date:</label> <input type="text" class="date-input roast_date">
                <label>Preparation Date:</label> <input type="text" class="date-input prep_date">
              </form>
            </div>

          </div>
          <div class="tab-pane" id="siphon">

            <div id="siphon_note">
              <form id="siphon_note_form">
                <label>Roast Date:</label> <input type="text" class="date-input roast_date">
                <label>Preparation Date:</label> <input type="text" class="date-input prep_date">
              </form>
            </div>

          </div>
        </div>

        <script>
          $(document).ready(function(){
            $('#myTab').tab();
            $('#myTab a').click(function (e) {
              e.preventDefault();
              $(this).tab('show');
            })
          });
        </script>

      </div>
    </div>

  </div>
</body>
</html>
